let websc,def_url="ws://192.168.0.14:5678",current_tp=0,chartCustomColors={red:"rgb(255, 99, 132)",orange:"rgb(255, 159, 64)",green:"rgb(75, 192, 192)",blue:"rgb(54, 162, 235)"},Un_arr=[0,0,0],Uabc_arr=[0,0,0],Iabc_arr=[0,0,0],Pabc_arr=[0,0,0],cos_arr=[0,0,0],MaxUn_arr=[0,0,0],MaxUabc_arr=[0,0,0],MaxIabc_arr=[0,0,0],MinUn_arr=[0,0,0],MinUabc_arr=[0,0,0],MinIabc_arr=[0,0,0],P_val=0,PA_val=0,Pr_val=0,cos_val=0,freq=0,chart_labels=["\u0424\u0430\u0437\u043D\u043E\u0435 \u043D\u0430\u043F\u0440\u044F\u0436\u0435\u043D\u0438\u0435","\u041B\u0438\u043D\u0435\u0439\u043D\u043E\u0435 \u043D\u0430\u043F\u0440\u044F\u0436\u0435\u043D\u0438\u0435","\u041B\u0438\u043D\u0435\u0439\u043D\u044B\u0435 \u0442\u043E\u043A\u0438","\u041F\u043E\u043B\u043D\u0430\u044F \u043C\u043E\u0449\u043D\u043E\u0441\u0442\u044C","\u041A\u043E\u044D\u0444\u0438\u0446\u0438\u0435\u043D\u0442 \u043C\u043E\u0449\u043D\u043E\u0441\u0442\u0438","\u0421\u0431\u0440\u043E\u0441\u0438\u0442\u044C \u043F\u0435\u0440\u0438\u043E\u0434"],chart_items=[["Ua-n","Ub-n","Uc-n"],["Ua-b","Ub-c","Ua-c"],["Ia","Ib","Ic"],["Pa","Pb","Pc"],["cos\u03C6 a","cos\u03C6 b","cos\u03C6 c"]],measurement_units=["B","A","KBA","KBAp","Hz","KB\u0442"],wanted_data_args=["Un","U","I","AP","cos"],tp_arr=["tp630","tp7"],alert_types=["alert-success","alert-danger","alert-warning","alert-info"],values_flag=0,selected_chart=0,time_range=[0,0];function viewInitialization(){selectTP(),dataValuesSelector(),openWsConnection()}function dataValuesSelector(){$("#cur_values").on("focus.bs.button",function(){values_flag=0,document.getElementById("reset_min_max").classList.add("invisible")}),$("#min_values").on("focus.bs.button",function(){values_flag=1,document.getElementById("reset_min_max").classList.remove("invisible");let a=document.getElementById("reset_min_max");a.onclick=function(){websc.send(JSON.stringify({action:"reset_min"}))}}),$("#max_values").on("focus.bs.button",function(){values_flag=2,document.getElementById("reset_min_max").classList.remove("invisible");let a=document.getElementById("reset_min_max");a.onclick=function(){websc.send(JSON.stringify({action:"reset_max"}))}}),$("#start_date").datepicker({maxDate:new Date,position:"top right"}),$("#end_date").datepicker({maxDate:new Date,position:"top right"}),$("#set_range").on("click",function(){chartDrawTypeSelector()}),$("#reset_zoom").on("click",function(){window.myChart.resetZoom()}),$(".dropdown-menu a").on("click",function(){drawSelectedGraph($(this).text())})}function selectTP(){let a=document.getElementById("tp_selector");a.addEventListener("change",function(){current_tp=a.selectedIndex})}function openWsConnection(){let a=new WebSocket(def_url);websc=a,a.onmessage=function(a){let b=JSON.parse(a.data);parseIncomingJson(b)},a.onopen=function(){console.log("Connection established")},a.onclose=function(a){a.wasClean?console.log("Connection closed clearly"):console.log("Connection interrupted"),console.log("Code: "+a.code+", reason: "+a.reason)},drawRealtimeChart()}function parseIncomingJson(a){let b,c=Object.keys(a)[0];0===current_tp?"tp630"===c?b=a[c][0]:"graph_data"===c&&drawCustomStaticChart(a[c]):1===current_tp?"tp7"===c?b=a[c][0]:"graph_data"===c&&drawCustomStaticChart(a[c]):void 0;b!==void 0&&(Un_arr=[b.Uan,b.Ubn,b.Ucn],Uabc_arr=[b.Uab,b.Ubc,b.Uac],Iabc_arr=[b.Ia,b.Ib,b.Ic],Pabc_arr=[VAtoKVA(b.APa),VAtoKVA(b.APb),VAtoKVA(b.APc)],cos_arr=[b.cosa,b.cosb,b.cosc],freq=b.freq,MaxUn_arr=[b.MaxUan,b.MaxUbn,b.MaxUcn],MaxUabc_arr=[b.MaxUab,b.MaxUbc,b.MaxUac],MaxIabc_arr=[b.MaxIa,b.MaxIb,b.MaxIc],MinUn_arr=[b.MinUan,b.MinUbn,b.MinUcn],MinUabc_arr=[b.MinUab,b.MinUbc,b.MinUac],MinIabc_arr=[b.MinIa,b.MinIb,b.MinIc],P_val=VAtoKVA(b.P),PA_val=VAtoKVA(b.Pa),Pr_val=VAtoKVA(b.Pr),cos_val=b.Pc),1===values_flag?setMinValues():2===values_flag?setMaxValues():setRealtimeValues()}function VAtoKVA(a){return parseInt(a)/1e3}function setRealtimeValues(){try{document.getElementById("uan").innerText=Un_arr[0].toString()+" "+measurement_units[0],document.getElementById("ubn").innerText=Un_arr[1].toString()+" "+measurement_units[0],document.getElementById("ucn").innerText=Un_arr[2].toString()+" "+measurement_units[0],document.getElementById("uab").innerText=Uabc_arr[0].toString()+" "+measurement_units[0],document.getElementById("ubc").innerText=Uabc_arr[1].toString()+" "+measurement_units[0],document.getElementById("uac").innerText=Uabc_arr[2].toString()+" "+measurement_units[0],document.getElementById("ia").innerText=Iabc_arr[0].toString()+" "+measurement_units[1],document.getElementById("ib").innerText=Iabc_arr[1].toString()+" "+measurement_units[1],document.getElementById("ic").innerText=Iabc_arr[2].toString()+" "+measurement_units[1],document.getElementById("pa").innerText=Pabc_arr[0].toString()+" "+measurement_units[2],document.getElementById("pb").innerText=Pabc_arr[1].toString()+" "+measurement_units[2],document.getElementById("pc").innerText=Pabc_arr[2].toString()+" "+measurement_units[2],document.getElementById("cosa").innerText=cos_arr[0].toString(),document.getElementById("cosb").innerText=cos_arr[1].toString(),document.getElementById("cosc").innerText=cos_arr[2].toString(),document.getElementById("p").innerText=P_val.toString()+" "+measurement_units[2],document.getElementById("pr").innerText=Pr_val.toString()+" "+measurement_units[3],document.getElementById("p_a").innerText=PA_val.toString()+" "+measurement_units[5],document.getElementById("cos").innerText=cos_val.toString(),document.getElementById("freq").innerText=freq.toString()+" "+measurement_units[4]}catch(a){console.log(a)}}function setMinValues(){document.getElementById("uan").innerText=MinUn_arr[0].toString()+" "+measurement_units[0],document.getElementById("ubn").innerText=MinUn_arr[1].toString()+" "+measurement_units[0],document.getElementById("ucn").innerText=MinUn_arr[2].toString()+" "+measurement_units[0],document.getElementById("uab").innerText=MinUabc_arr[0].toString()+" "+measurement_units[0],document.getElementById("ubc").innerText=MinUabc_arr[1].toString()+" "+measurement_units[0],document.getElementById("uac").innerText=MinUabc_arr[2].toString()+" "+measurement_units[0],document.getElementById("ia").innerText=MinIabc_arr[0].toString()+" "+measurement_units[1],document.getElementById("ib").innerText=MinIabc_arr[1].toString()+" "+measurement_units[1],document.getElementById("ic").innerText=MinIabc_arr[2].toString()+" "+measurement_units[1],document.getElementById("pa").innerText="",document.getElementById("pb").innerText="",document.getElementById("pc").innerText="",document.getElementById("cosa").innerText="",document.getElementById("cosb").innerText="",document.getElementById("cosc").innerText="",document.getElementById("p").innerText="",document.getElementById("pr").innerText="",document.getElementById("p_a").innerText="",document.getElementById("cos").innerText="",document.getElementById("freq").innerText=freq.toString()+" "+measurement_units[4]}function setMaxValues(){document.getElementById("uan").innerText=MaxUn_arr[0].toString()+" "+measurement_units[0],document.getElementById("ubn").innerText=MaxUn_arr[1].toString()+" "+measurement_units[0],document.getElementById("ucn").innerText=MaxUn_arr[2].toString()+" "+measurement_units[0],document.getElementById("uab").innerText=MaxUabc_arr[0].toString()+" "+measurement_units[0],document.getElementById("ubc").innerText=MaxUabc_arr[1].toString()+" "+measurement_units[0],document.getElementById("uac").innerText=MaxUabc_arr[2].toString()+" "+measurement_units[0],document.getElementById("ia").innerText=MaxIabc_arr[0].toString()+" "+measurement_units[1],document.getElementById("ib").innerText=MaxIabc_arr[1].toString()+" "+measurement_units[1],document.getElementById("ic").innerText=MaxIabc_arr[2].toString()+" "+measurement_units[1],document.getElementById("pa").innerText="",document.getElementById("pb").innerText="",document.getElementById("pc").innerText="",document.getElementById("cosa").innerText="",document.getElementById("cosb").innerText="",document.getElementById("cosc").innerText="",document.getElementById("p").innerText="",document.getElementById("pr").innerText="",document.getElementById("p_a").innerText="",document.getElementById("cos").innerText="",document.getElementById("freq").innerText=freq.toString()+" "+measurement_units[4]}function drawSelectedGraph(a){switch(a){case chart_labels[0]:selected_chart=0;break;case chart_labels[1]:selected_chart=1;break;case chart_labels[2]:selected_chart=2;break;case chart_labels[3]:selected_chart=3;break;case chart_labels[4]:selected_chart=4;break;case chart_labels[5]:clearRange(),drawRealtimeChart();break;default:selected_chart=0;}chartDrawTypeSelector()}function isRangeTimeValid(){let a=document.getElementById("start_date"),b=document.getElementById("end_date"),c=0,d=0;return isNotEmpty(a.value)&&(c=getMillisOfDate(a.value)),isNotEmpty(b.value)&&(d=getMillisOfDate(b.value)),0!==c&&0!==d?isRangeValid(c,d)?1:-1:0}function isNotEmpty(a){return a!==void 0||""!==a}function getMillisOfDate(a){let b=a.split(" "),c=b[0].split("."),d=c[1]+"."+c[0]+"."+c[2]+" "+b[1];return isNaN(Date.parse(d))?0:Date.parse(d)}function isRangeValid(a,b){if(a>b){let c=a;a=b,b=c}return!(216e5<b-a)&&(time_range[0]=a,time_range[1]=b,!0)}function showAlert(a,b){let c=document.getElementById("notifications"),d=document.createElement("div"),e=document.createElement("button"),f=document.createElement("span");d.setAttribute("class","alert alert-dismissible ztta-alert-top fade show"),d.classList.add(a),d.setAttribute("role","alert"),d.innerText=b,e.setAttribute("type","button"),e.setAttribute("class","close"),e.setAttribute("data-dismiss","alert"),e.setAttribute("aria-label","close"),f.setAttribute("aria-hidden","true"),f.innerHTML="&times",e.appendChild(f),d.appendChild(e),c.appendChild(d)}function chartDrawTypeSelector(){1===isRangeTimeValid()?drawStaticChart(wanted_data_args[selected_chart],time_range[0],time_range[1]):0===isRangeTimeValid()?drawRealtimeChart():showAlert(alert_types[1],"\u0414\u0438\u0430\u043F\u0430\u0437\u043E\u043D \u043D\u0435 \u0434\u043E\u043B\u0436\u0435\u043D \u043F\u0440\u0435\u0432\u044B\u0448\u0430\u0442\u044C 6 \u0447\u0430\u0441\u043E\u0432")}function drawStaticChart(a,b,c){websc.send(JSON.stringify({action:"get",begin_ms:b,end_ms:c,par:a,tp:tp_arr[current_tp]}))}function drawRealtimeChart(){clearCurrentChart();let a;switch(selected_chart){case 0:a=buildCustomChartConfig(chart_labels[0],measurement_units[0],onRefreshUn,chart_items[0]);break;case 1:a=buildCustomChartConfig(chart_labels[1],measurement_units[0],onRefreshUabc,chart_items[1]);break;case 2:a=buildCustomChartConfig(chart_labels[2],measurement_units[1],onRefreshIabc,chart_items[2]);break;case 3:a=buildCustomChartConfig(chart_labels[3],measurement_units[2],onRefreshPabc,chart_items[3]);break;case 4:a=buildCustomChartConfig(chart_labels[4],"",onRefreshCos,chart_items[4]);break;default:a=buildCustomChartConfig(chart_labels[0],measurement_units[0],onRefreshUn,chart_items[0]);}let b=document.getElementById("myChart").getContext("2d");window.myChart=new Chart(b,a)}function clearRange(){document.getElementById("start_date").value="",document.getElementById("end_date").value="",time_range=[0,0]}function buildCustomChartConfig(a,b,c,d){let e={type:"line",data:{datasets:[]},options:{title:{display:!0,text:a},scales:{xAxes:[{type:"realtime",realtime:{duration:2e4,refresh:1e3,delay:2e3,onRefresh:onRefreshUn}}],yAxes:[{type:"linear",display:!0,scaleLabel:{display:!0,labelString:b}}]},responsive:!0,tooltips:{mode:"nearest",intersect:!1},hover:{mode:"nearest",intersect:!0},pan:{enabled:!0,mode:"x",rangeMax:{x:4e3},rangeMin:{x:0}},zoom:{enabled:!0,mode:"x",rangeMax:{x:5e4},rangeMin:{x:100}}}};return e.options.scales.xAxes[0].realtime.onRefresh=c,e.data.datasets.push(buildCustomChartDataset(d[0],0)),e.data.datasets.push(buildCustomChartDataset(d[1],2)),e.data.datasets.push(buildCustomChartDataset(d[2],3)),e}function buildCustomChartDataset(a,b){let c=Chart.helpers.color,d=Object.keys(chartCustomColors),e=d[b],f=chartCustomColors[e];return{label:a,backgroundColor:c(f).alpha(.5).rgbString(),borderColor:f,fill:!1,cubicInterpolationMode:"monotone",pointRadius:0,data:[]}}function onRefreshUn(a){a.config.data.datasets[0].data.push({x:Date.now(),y:Un_arr[0]}),a.config.data.datasets[1].data.push({x:Date.now(),y:Un_arr[1]}),a.config.data.datasets[2].data.push({x:Date.now(),y:Un_arr[2]})}function onRefreshUabc(a){a.config.data.datasets[0].data.push({x:Date.now(),y:Uabc_arr[0]}),a.config.data.datasets[1].data.push({x:Date.now(),y:Uabc_arr[1]}),a.config.data.datasets[2].data.push({x:Date.now(),y:Uabc_arr[2]})}function onRefreshIabc(a){a.config.data.datasets[0].data.push({x:Date.now(),y:Iabc_arr[0]}),a.config.data.datasets[1].data.push({x:Date.now(),y:Iabc_arr[1]}),a.config.data.datasets[2].data.push({x:Date.now(),y:Iabc_arr[2]})}function onRefreshPabc(a){a.config.data.datasets[0].data.push({x:Date.now(),y:Pabc_arr[0]}),a.config.data.datasets[1].data.push({x:Date.now(),y:Pabc_arr[1]}),a.config.data.datasets[2].data.push({x:Date.now(),y:Pabc_arr[2]})}function onRefreshCos(a){a.config.data.datasets[0].data.push({x:Date.now(),y:cos_arr[0]}),a.config.data.datasets[1].data.push({x:Date.now(),y:cos_arr[1]}),a.config.data.datasets[2].data.push({x:Date.now(),y:cos_arr[2]})}function clearCurrentChart(){try{window.myChart.destroy()}catch(a){console.log(a)}}function drawCustomStaticChart(a){clearCurrentChart();let b=buildStaticCustomDataset(selected_chart);switch(selected_chart){case 0:fillDataUn(b,a);break;case 1:fillDataUabc(b,a);break;case 2:fillDataIabc(b,a);break;case 3:fillDataPabc(b,a);break;case 4:fillDataCos(b,a);break;default:fillDataUn(b,a);}let c=document.getElementById("myChart").getContext("2d");window.myChart=new Chart(c,b)}function buildStaticCustomDataset(a){let b=a;1===a&&(b=0);let c=buildStaticChartConfig(chart_labels[a],measurement_units[b]);for(let b=0;3>b;b++)c.data.datasets.push(buildCustomChartDataset(chart_items[a][b],b+1));return c}function buildStaticChartConfig(a,b){return config={type:"line",data:{labels:[],datasets:[]},options:{title:{display:!0,text:a},scales:{yAxes:[{type:"linear",display:!0,scaleLabel:{display:!0,labelString:b}}]},tooltips:{mode:"nearest",intersect:!1},hover:{mode:"nearest",intersect:!1},pan:{enabled:!1,mode:"x",rangeMax:{x:4e3},rangeMin:{x:0}},zoom:{enabled:!0,mode:"x",rangeMax:{x:null},rangeMin:{x:1e3}}}}}function fillDataUn(a,b){for(let c=0;c<b.length;c++)a.data.datasets[0].data.push({x:b[c].time,y:b[c].Uan}),a.data.datasets[1].data.push({x:b[c].time,y:b[c].Ubn}),a.data.datasets[2].data.push({x:b[c].time,y:b[c].Ucn}),a.data.labels.push(convertMsecToTime(b[c].time))}function fillDataUabc(a,b){for(let c=0;c<b.length;c++)a.data.datasets[0].data.push({x:b[c].time,y:b[c].Uab}),a.data.datasets[1].data.push({x:b[c].time,y:b[c].Ubc}),a.data.datasets[2].data.push({x:b[c].time,y:b[c].Uac}),a.data.labels.push(convertMsecToTime(b[c].time))}function fillDataIabc(a,b){for(let c=0;c<b.length;c++)a.data.datasets[0].data.push({x:b[c].time,y:b[c].Ia}),a.data.datasets[1].data.push({x:b[c].time,y:b[c].Ib}),a.data.datasets[2].data.push({x:b[c].time,y:b[c].Ic}),a.data.labels.push(convertMsecToTime(b[c].time))}function fillDataPabc(a,b){for(let c=0;c<b.length;c++)a.data.datasets[0].data.push({x:b[c].time,y:VAtoKVA(b[c].APa)}),a.data.datasets[1].data.push({x:b[c].time,y:VAtoKVA(b[c].APb)}),a.data.datasets[2].data.push({x:b[c].time,y:VAtoKVA(b[c].APc)}),a.data.labels.push(convertMsecToTime(b[c].time))}function fillDataCos(a,b){for(let c=0;c<b.length;c++)a.data.datasets[0].data.push({x:b[c].time,y:b[c].cosa}),a.data.datasets[1].data.push({x:b[c].time,y:b[c].cosb}),a.data.datasets[2].data.push({x:b[c].time,y:b[c].cosc}),a.data.labels.push(convertMsecToTime(b[c].time))}function convertMsecToTime(a){let b=new Date(parseInt(a)),c=b.getHours(),d=b.getMinutes(),e=b.getSeconds();return 10>c&&(c="0"+c),10>d&&(d="0"+d),10>e&&(e="0"+e),c+":"+d+":"+e}